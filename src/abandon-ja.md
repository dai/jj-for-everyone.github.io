# コミットとブックマークの削除

````admonish reset title="Reset your progress" collapsible=true
To reset your progress to the start of this chapter, run the following command:

```sh
curl https://jj-for-everyone.github.io/reset.sh | bash -s abandon
cd ~/jj-tutorial/repo
```
````

Aliceが以前に置いておいたfor-loop実験を思い出す。
Jujutsuでは、そのような実験を好きなだけ保持できます。
これらのコマンドでいくつかをシミュレートしましょう：

```sh
jj commit -m "Experiment: Migrate to shiny new framework"
jj git push --change @-
jj new main
jj commit -m "Experiment: Improve scalability using microservices"
jj git push --change @-
jj new main
jj commit -m "Experiment: Apply SOLID design patterns"
jj git push --change @-
jj new main
```

<!-- generated by aha script -->
<pre class="aha">
<span class="bold "></span><span class="bold green ">@</span>  <span class="bold "></span><span class="bold highlighted purple ">v</span><span class="bold highlighted dimgray ">qytywws</span><span class="bold "> </span><span class="bold yellow ">alice@local</span><span class="bold "> </span><span class="bold highlighted cyan ">2025-08-31 14:29:56</span><span class="bold "> </span><span class="bold highlighted blue ">9</span><span class="bold highlighted dimgray ">bdb2d1d</span><span class="bold "></span>
│  <span class="bold "></span><span class="bold highlighted green ">(empty)</span><span class="bold "> </span><span class="bold highlighted green ">(no description set)</span><span class="bold "></span>
│ ○  <span class="bold "></span><span class="bold purple ">o</span><span class="highlighted dimgray ">qsqtxwo</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-31 14:29:56</span> <span class="purple ">push-oqsqtxwowvuw</span> <span class="bold "></span><span class="bold blue ">2</span><span class="highlighted dimgray ">ffeb883</span>
├─╯  <span class="green ">(empty)</span> Experiment: Apply SOLID design patterns
│ ○  <span class="bold "></span><span class="bold purple ">l</span><span class="highlighted dimgray ">qpnzsmz</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-31 14:29:56</span> <span class="purple ">push-lqpnzsmzkxry</span> <span class="bold "></span><span class="bold blue ">f</span><span class="highlighted dimgray ">4cf1d7f</span>
├─╯  <span class="green ">(empty)</span> Experiment: Improve scalability using microservices
│ ○  <span class="bold "></span><span class="bold purple ">r</span><span class="highlighted dimgray ">ppuwxxp</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-31 14:29:56</span> <span class="purple ">push-rppuwxxpnkqu</span> <span class="bold "></span><span class="bold blue ">8</span><span class="highlighted dimgray ">c44777f</span>
├─╯  <span class="green ">(empty)</span> Experiment: Migrate to shiny new framework
<span class="bold "></span><span class="bold highlighted cyan ">◆</span>  <span class="bold "></span><span class="bold purple ">s</span><span class="highlighted dimgray ">nnoxnvq</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-31 14:29:56</span> <span class="purple ">main</span> <span class="green ">git_head()</span> <span class="bold "></span><span class="bold blue ">3</span><span class="highlighted dimgray ">46c0acd</span>
│  Merge repetition and translation of greeting
~
</pre>

Bobとの長い議論の後、Aliceはこれらの実験が良いアイデアではないことを認める。
彼女はコミットとブックマークを削除することを決意する。

それを削除するjjコマンドは `jj abandon <change-id>` です。
各実験コミットの変更IDでこのコマンドを3回呼び出すことができます。
または、以下のコマンドをコピーして一度にすべて削除することもできます：

```sh
jj abandon 'description("Experiment")'
```

<!-- generated by aha script -->
<pre class="aha">
Abandoned 3 commits:
  <span class="bold "></span><span class="bold purple ">o</span><span class="highlighted dimgray ">qsqtxwo</span> <span class="bold "></span><span class="bold blue ">2</span><span class="highlighted dimgray ">ffeb883</span> <span class="purple ">push-oqsqtxwowvuw</span><span class="highlighted dimgray "> | </span><span class="green ">(empty)</span> Experiment: Apply SOLID design patterns
  <span class="bold "></span><span class="bold purple ">l</span><span class="highlighted dimgray ">qpnzsmz</span> <span class="bold "></span><span class="bold blue ">f</span><span class="highlighted dimgray ">4cf1d7f</span> <span class="purple ">push-lqpnzsmzkxry</span><span class="highlighted dimgray "> | </span><span class="green ">(empty)</span> Experiment: Improve scalability using microservices
  <span class="bold "></span><span class="bold purple ">r</span><span class="highlighted dimgray ">ppuwxxp</span> <span class="bold "></span><span class="bold blue ">8</span><span class="highlighted dimgray ">c44777f</span> <span class="purple ">push-rppuwxxpnkqu</span><span class="highlighted dimgray "> | </span><span class="green ">(empty)</span> Experiment: Migrate to shiny new framework
Deleted bookmarks: push-lqpnzsmzkxry, push-oqsqtxwowvuw, push-rppuwxxpnkqu
<span class="bold "></span><span class="bold cyan ">Hint: </span>Deleted bookmarks can be pushed by name or all at once with `jj git push --deleted`.
</pre>

`jj abandon` の出力は、3つのコミットが削除され、それらを指していたブックマークも削除されたことを示しています。
Jujutsuは、コミットを削除したい場合、通常それを指しているブックマークも必要ないと仮定します。
もしそれを保持したい場合、`jj abandon` を実行する前にブックマークを保持したいコミットに移動してください。

それでも、ブックマークはローカルでのみ削除されます。
新しいまたは移動したブックマークと同様に、削除されたものは明示的に同期する必要があります。
これにより、ミスを修正しやすくなります。
ローカルでブックマークを誤って削除した場合、`jj undo` でそれを元に戻すことができます。
リモートで既に削除した場合、復元にはもう少し労力が必要です。
削除されたブックマークをリモートと同期しましょう：

```sh
jj git push --deleted
```

````admonish note title="Gitを直接使用する場合の重複コミット" collapsible=true
JujutsuがGitと互換性があることを話しました。
それは `.git` ディレクトリを作成し、それがGit自体によって作成および管理されたかのように見えます。
これにより、他のツールがGitと相互運用する場合にシームレスに動作します。

経験則として、この相互運用性は他のツールが `.git` ディレクトリを**読み取り専用**で使用する場合に完璧に動作します。
しかし、他のツールがそれを変更する場合、わずかな問題が発生する可能性があります。
修正は通常シンプルですが、何がうまくいかないかを直感的に理解するのに役立ちます。

簡単な例を作りましょう。
以下のコマンドはJujutsuのワーキングコピーコミットにファイルを追加します。
その後、Git自体で新しいコミットを作成します。
`jj log` を実行すると、ブランチオフしたコミットが表示され、奇妙に見えます。

```sh
touch some_file
jj status # record new file into working copy
git commit -am "add some file" # create commit with git, bypassing jj
jj log
```

<!-- generated by aha script -->
<pre class="aha">
<span class="bold "></span><span class="bold green ">@</span>  <span class="bold "></span><span class="bold highlighted purple ">n</span><span class="bold highlighted dimgray ">wstlotv</span><span class="bold "> </span><span class="bold yellow ">alice@local</span><span class="bold "> </span><span class="bold highlighted cyan ">2025-08-31 14:44:23</span><span class="bold "> </span><span class="bold highlighted blue ">9</span><span class="bold highlighted dimgray ">28b48f4</span><span class="bold "></span>
│  <span class="bold "></span><span class="bold highlighted green ">(empty)</span><span class="bold "> </span><span class="bold highlighted green ">(no description set)</span><span class="bold "></span>
○  <span class="bold "></span><span class="bold purple ">y</span><span class="highlighted dimgray ">qyzyzzo</span> <span class="yellow ">remo@buenzli.dev</span> <span class="cyan ">2025-08-31 14:44:22</span> <span class="green ">git_head()</span> <span class="bold "></span><span class="bold blue ">30</span><span class="highlighted dimgray ">e0eec4</span>
│  add some file
│ ○  <span class="bold "></span><span class="bold purple ">v</span><span class="highlighted dimgray ">qytywws</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-31 14:44:05</span> <span class="bold "></span><span class="bold blue ">7</span><span class="highlighted dimgray ">0588b87</span>
├─╯  <span class="yellow ">(no description set)</span>
<span class="bold "></span><span class="bold highlighted cyan ">◆</span>  <span class="bold "></span><span class="bold purple ">s</span><span class="highlighted dimgray ">nnoxnvq</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-31 14:29:56</span> <span class="purple ">main</span> <span class="bold "></span><span class="bold blue ">34</span><span class="highlighted dimgray ">6c0acd</span>
│  Merge repetition and translation of greeting
~
</pre>

このブランチオフしたコミットは、実際にはJujutsuの以前のワーキングコピーコミットです。
JujutsuはGitで作成されたコミットが基本的に同じであることを知りません。
（両方のコミットを `jj show` すると、同じファイル変更が含まれていることがわかります。）

この場合の解決策は、単にダングリングコミットを `jj abandon` することです、おそらく99%の異なるツールがGitデータベースを変更した場合の問題はこれと同じです。
次にJujutsuを実行すると、知らない新しいコミットを見つけるので、すべてを保持します。
その後、必要ないものを削除する必要があります。

このトピック全体をクリーンアップしましょう：

```sh
jj abandon main+ # abandon direct children of main
```
````

## 不変性

これはコミット履歴を変更する `jj abandon` コマンドについて話す良い機会です。
コミットは起こったことを表します。
コミットを削除することで、「それは起こらなかった」と基本的に言っているのです。
`jj rebase` を学ぶ最初の時間に履歴を書き換えたことを覚えていますか？
または、それを `jj abandon` した記憶を？

履歴の書き換えは、多くの場合、完全に正常で論理的なことです。
しかし、それは危険です！
例えば、Aliceが `main` ブランチのコミットを書き換えたらどうなるでしょうか？
Bobにとっては非常に混乱するでしょう！
Bobのブックマークが指すコミットをAliceが書き換えた場合も同様に混乱します。
これにより、AliceとBobが直面するさまざまな複雑な問題があります。

これらの問題を避けるために、バージョン管理システムで協力する人々は、単純な経験則に従います：

**共有ブランチで履歴を書き換えない。**

通常、それは `main` ブランチだけですが、プロジェクトによってはもっとあるかもしれません。

個人ブランチでは、通常もっとリラックスしています。
AliceはBobが自分のブランチで履歴を自由に書き換えることを期待すべきです。
その見返りに、彼女は自分のブランチで履歴を書き換えることができます。
誰かのブランチの履歴が安定していることに依存する必要がある場合、おそらく彼らと話すべきです。

今、素晴らしいニュース：
**Jujutsuはデフォルトでこれらのルールを強制します！**
これにより、ほとんどの時間を心配する必要がありません。
`main` ブランチの最新コミットを削除してみてください：

```sh
jj abandon main
```

<!-- generated by aha script -->
<pre class="aha">
<span class="bold "></span><span class="bold red ">Error: </span><span class="bold ">Commit 346c0acd36db is immutable</span>
<span class="bold "></span><span class="bold cyan ">Hint: </span>Could not modify commit: <span class="bold "></span><span class="bold purple ">s</span><span class="highlighted dimgray ">nnoxnvq</span> <span class="bold "></span><span class="bold blue ">34</span><span class="highlighted dimgray ">6c0acd</span> <span class="purple ">main</span><span class="highlighted dimgray "> | </span>Merge repetition and translation of greeting
<span class="bold "></span><span class="bold cyan ">Hint: </span>Immutable commits are used to protect shared history.
<span class="bold "></span><span class="bold cyan ">Hint: </span>For more information, see:
      - https://jj-vcs.github.io/jj/latest/config/#set-of-immutable-commits
      - `jj help -k config`, &quot;Set of immutable commits&quot;
<span class="bold "></span><span class="bold cyan ">Hint: </span>This operation would rewrite 1 immutable commits.
</pre>

`main` ブランチのものを誤って削除しないように保護されています。
保護されたコミットは**不変**と呼ばれ、Jujutsuはロググラフでそれらを**ダイヤモンド**（**`◆`**）記号で表します。
保護されていないコミットは**可変**と呼ばれ、**円**（**`○`**）で表されます。
これらの保護は `jj abandon` と `jj rebase` にのみ適用されるのではなく、既存の履歴を編集するすべてのコマンドに適用されます。
次のレベルでそのようなコマンドをたくさん学びます。
