# マージ競合の解決

````admonish reset title="Reset your progress" collapsible=true
To reset your progress to the start of this chapter, run the following command:

```sh
curl https://jj-for-everyone.github.io/reset.sh | bash -s conflict
cd ~/jj-tutorial/repo
```
````

Alice & Bobは次のプログラミング講義に参加しました。
そこで彼らはPythonのループについて学びました。
Aliceは実験に戻って修正しようとします：

```sh
jj new 'description("WIP: Add for loop")'
```

彼女のコードは現在こうなっています：

```py
for (i = 0; i < 10; i = i + 1):
    print('Hello, world!')
```

この構文は間違っていますので、Aliceは講義で学んだ構文で修正します：

```py
for _ in range(10):
    print('Hello, world!')
```

ファイルを手動で編集するか、このコマンドを実行します：

```sh
echo "for _ in range(10):
    print('Hello, world!')" > hello.py
```

その修正をコミットしましょう：

```sh
jj commit -m "Fix loop syntax"
```

<!-- generated by aha script -->
<pre class="aha">
<span class="bold "></span><span class="bold green ">@</span>  <span class="bold "></span><span class="bold highlighted purple ">z</span><span class="highlighted dimgray ">zlzryut</span><span class="bold "> </span><span class="bold yellow ">alice@local</span><span class="bold "> </span><span class="bold highlighted cyan ">2025-08-23 21:21:54</span><span class="bold "> </span><span class="bold highlighted blue ">5</span><span class="highlighted dimgray ">b7e967e</span><span class="bold "></span>
│  <span class="bold "></span><span class="bold highlighted green ">(empty)</span><span class="bold "> </span><span class="bold highlighted green ">(no description set)</span><span class="bold "></span>
○  <span class="bold "></span><span class="bold purple ">o</span><span class="highlighted dimgray ">xnuoryz</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-23 21:21:54</span> <span class="green ">git_head()</span> <span class="bold "></span><span class="bold blue ">c</span><span class="highlighted dimgray ">6042124</span>
│  Fix loop syntax
○  <span class="bold "></span><span class="bold purple ">t</span><span class="highlighted dimgray ">vrzpsvy</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-23 21:21:53</span> <span class="purple ">push-tvrzpsvypkqk</span> <span class="bold "></span><span class="bold blue ">6</span><span class="highlighted dimgray ">e468237</span>
│  WIP: Add for loop (need to fix syntax)
│ <span class="bold "></span><span class="bold highlighted cyan ">◆</span>  <span class="bold "></span><span class="bold purple ">q</span><span class="highlighted dimgray ">uvtvrzl</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-23 21:21:54</span> <span class="purple ">main</span> <span class="bold "></span><span class="bold blue ">d</span><span class="highlighted dimgray ">0c3efcd</span>
│ │  Print German and French greetings as well
│ <span class="highlighted dimgray ">~</span>  <span class="highlighted dimgray ">(elided revisions)</span>
├─╯
<span class="bold "></span><span class="bold highlighted cyan ">◆</span>  <span class="bold "></span><span class="bold purple ">k</span><span class="highlighted dimgray ">rymmwqm</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-23 21:21:53</span> <span class="bold "></span><span class="bold blue ">1</span><span class="highlighted dimgray ">581674f</span>
│  <span class="green ">(empty)</span> Merge code and documentation for hello-world
~
</pre>

## 競合の作成

Aliceは今ループを追加したコードを `main` にプッシュしようとします。
彼女は明示的なマージコミットを作成することを決めます：

```sh
jj new main @-
```

<!-- generated by aha script -->
<pre class="aha">
Working copy  (@) now at: <span class="bold "></span><span class="bold highlighted purple ">s</span><span class="bold highlighted dimgray ">rpklysn</span><span class="bold "> </span><span class="bold highlighted blue ">0</span><span class="bold highlighted dimgray ">f64cf5a</span><span class="bold "> </span><span class="bold highlighted red ">(conflict)</span><span class="bold "> </span><span class="bold highlighted green ">(empty)</span><span class="bold "> </span><span class="bold highlighted green ">(no description set)</span>
Parent commit (@-)      : <span class="bold "></span><span class="bold purple ">q</span><span class="highlighted dimgray ">uvtvrzl</span> <span class="bold "></span><span class="bold blue ">d</span><span class="highlighted dimgray ">0c3efcd</span> <span class="purple ">main</span><span class="highlighted dimgray "> | </span>Print German and French greetings as well
Parent commit (@-)      : <span class="bold "></span><span class="bold purple ">o</span><span class="highlighted dimgray ">xnuoryz</span> <span class="bold "></span><span class="bold blue ">c</span><span class="highlighted dimgray ">6042124</span> Fix loop syntax
Added 1 files, modified 2 files, removed 0 files
<span class="bold "></span><span class="bold yellow ">Warning: </span><span class="bold ">There are unresolved conflicts at these paths:</span>
hello.py    <span class="yellow ">2-sided conflict</span>
</pre>

おお！
新しく作成されたマージコミットに恐ろしい赤い `(conflict)` マーカーがあり、`hello.py` ファイルの競合についての警告があります。
競合はログでも見えます：

<!-- generated by aha script -->
<pre class="aha">
<span class="bold "></span><span class="bold highlighted red ">@</span>    <span class="bold "></span><span class="bold highlighted purple ">l</span><span class="bold highlighted dimgray ">ozqokkt</span><span class="bold "> </span><span class="bold yellow ">alice@local</span><span class="bold "> </span><span class="bold highlighted cyan ">2025-08-23 21:34:35</span><span class="bold "> </span><span class="bold highlighted blue ">f</span><span class="highlighted dimgray ">e21ff1e</span><span class="bold "> </span><span class="bold highlighted red ">conflict</span><span class="bold "></span>
├─╮  <span class="bold "></span><span class="bold highlighted green ">(empty)</span><span class="bold "> </span><span class="bold highlighted green ">(no description set)</span><span class="bold "></span>
│ ○  <span class="bold "></span><span class="bold purple ">o</span><span class="highlighted dimgray ">xnuoryz</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-23 21:21:54</span> <span class="bold "></span><span class="bold blue ">c</span><span class="highlighted dimgray ">6042124</span>
│ │  Fix loop syntax
│ ○  <span class="bold "></span><span class="bold purple ">t</span><span class="highlighted dimgray ">vrzpsvy</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-23 21:21:53</span> <span class="purple ">push-tvrzpsvypkqk</span> <span class="bold "></span><span class="bold blue ">6</span><span class="highlighted dimgray ">e468237</span>
│ │  WIP: Add for loop (need to fix syntax)
<span class="bold "></span><span class="bold highlighted cyan ">◆</span> │  <span class="bold "></span><span class="bold purple ">q</span><span class="highlighted dimgray ">uvtvrzl</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-23 21:21:54</span> <span class="purple ">main</span> <span class="green ">git_head()</span> <span class="bold "></span><span class="bold blue ">d</span><span class="highlighted dimgray ">0c3efcd</span>
│ │  Print German and French greetings as well
<span class="highlighted dimgray ">~</span> │  <span class="highlighted dimgray ">(elided revisions)</span>
├─╯
<span class="bold "></span><span class="bold highlighted cyan ">◆</span>  <span class="bold "></span><span class="bold purple ">k</span><span class="highlighted dimgray ">rymmwqm</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-23 21:21:53</span> <span class="bold "></span><span class="bold blue ">1</span><span class="highlighted dimgray ">581674f</span>
│  <span class="green ">(empty)</span> Merge code and documentation for hello-world
~
</pre>

おそらく既に推測したでしょう。
マージの一方の側、`main` ブランチは `hello.py` ファイルをある方法で変更しました（他の言語を追加）。
もう一方の側はループを追加しました。
Jujutsuはこれらの変更を組み合わせる方法を知りません。
これは**競合**と呼ばれる状況です。

## 競合マーカーの読み方

競合したファイル `hello.py` をテキストエディタで開くか、`cat hello.py` を実行して内容を見てください：

```
<<<<<<< Conflict 1 of 1
%%%%%%% Changes from base to side #1
 print('Hello, world!')
+print('Hallo, Welt!')
+print('Bonjour, le monde!')
+++++++ Contents of side #2
for _ in range(10):
    print('Hello, world!')
>>>>>>> Conflict 1 of 1 ends
```

うわー、それはひどい。
これを競合を理解するためのステップバイステップで解きほぐしてみましょう。

最初と最後の行に焦点を当ててください：

```
<<<<<<< Conflict 1 of 1
...
>>>>>>> Conflict 1 of 1 ends
```

これらの2つの行は競合の開始と終了を示します。
大きなファイルでは、競合しない部分が大部分を占めることが多いです。
両方の側が同じ行を変更した場合のみ、Jujutsuは競合を報告します。
これらの競合した行のチャンクは、開始と終了マーカーとともに番号付きセクションとして現れます。
私たちの例では、ファイルが非常に小さいため、全体が単一の競合です。

次に、競合内の最初のセクションに焦点を当ててください：

```
%%%%%%% Changes from base to side #1
 print('Hello, world!')
+print('Hallo, Welt!')
+print('Bonjour, le monde!')
```

このセクションの "heading" は "Changes from base to side #1" と言っています。
"base" と "side #1" とは何でしょうか？
"base" はマージの2つのブランチが分岐し始めたコミットを指します。
これは上記のログで "Merge code and documentation for hello-world" という説明のコミットです。

側番号はマージで指定したコミットの順序に対応します。
マージコマンドは `jj new main @-` でしたので、"side #1" は `main` ブランチに対応します。

このセクションは、マージの `main` ブランチで競合した行にどのような変更が加えられたかを示しています。
変更を示す形式は一般的な "diff" 形式です。
この形式では、すべての行がスペース、マイナス `-` またはプラス `+` の記号でプレフィックスされます。
スペースは行が変更されていないことを意味します。
マイナスは行が削除されたことを意味し、プラスは行が追加されたことを意味します。
_変更された_行は、削除された行と追加された行として表されます。

この場合、英語の挨拶（変更なし）と2つの追加された行（ドイツ語とフランス語のもの）があります。

競合の2番目のセクションに移りましょう：

```
+++++++ Contents of side #2
for _ in range(10):
    print('Hello, world!')
```

このセクションは "Changes from base to side #2" を示していません、単に "Contents of side #2" を示しています。
理由は、前のセクションからbaseの状態を推測できるからです。

この説明は非常に冗長に思えたかもしれません。
しかし、マージ競合はこれよりも複雑になることがあります。
幸いにも、これで対処する準備が少しできたはずです。

## 競合の修正

各側の状態を理解したので、どうやって修正するのでしょうか？
ここには**機械的な解決策はありません**！
もしあったら、Jujutsuがあなたのためにそれを行っていたでしょう。
競合のポイントは、正しい解決が競合した変更の意味に依存することです。

この場合、競合した変更は：
- 10回ループで挨拶を印刷する。
- ドイツ語とフランス語の挨拶も追加する。

これらの2つの変更をマージする場合、ドイツ語とフランス語の挨拶も10回繰り返すべきでしょうか？
すべての言語を繰り返すべきか、きれいに分離すべきか？

例として、これらの変更をマージする3つの合理的な方法があります：

1. 英語の挨拶のみを繰り返す：
    ```py
    for _ in range(10):
        print('Hello, world!')
    print('Hallo, Welt!')
    print('Bonjour, le monde!')
    ```

1. すべての言語を繰り返し、インターリーブする：
    ```py
    for _ in range(10):
        print('Hello, world!')
        print('Hallo, Welt!')
        print('Bonjour, le monde!')
    ```

1. すべての言語を繰り返すが、分離する：
    ```py
    for _ in range(10):
        print('Hello, world!')
    for _ in range(10):
        print('Hallo, Welt!')
    for _ in range(10):
        print('Bonjour, le monde!')
    ```

ポイントがわかったと思います。
マージ競合を正しく解決するには、通常、少し脳を使う必要があります。

2番目のオプションを競合解決として選びます。
競合マーカーを手動で編集するか、単にこのコマンドでファイルを置き換えます：

```sh
echo "for _ in range(10):
    print('Hello, world!')
    print('Hallo, Welt!')
    print('Bonjour, le monde!')" > hello.py
```

ワーキングコピーコミットが競合としてマークされなくなったことを確認するためにログをチェックしましょう：

<!-- generated by aha script -->
<pre class="aha">
<span class="bold "></span><span class="bold green ">@</span>    <span class="bold "></span><span class="bold highlighted purple ">kp</span><span class="bold highlighted dimgray ">rnqvtk</span><span class="bold "> </span><span class="bold yellow ">alice@local</span><span class="bold "> </span><span class="bold highlighted cyan ">2025-08-24 07:41:36</span><span class="bold "> </span><span class="bold highlighted blue ">b4</span><span class="bold highlighted dimgray ">6df36e</span><span class="bold "></span>
├─╮  <span class="bold "></span><span class="bold yellow ">(no description set)</span><span class="bold "></span>
│ ○  <span class="bold "></span><span class="bold purple ">t</span><span class="highlighted dimgray ">tuuwuvl</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-24 07:38:02</span> <span class="bold "></span><span class="bold blue ">c</span><span class="highlighted dimgray ">8479848</span>
│ │  Fix loop syntax
│ ○  <span class="bold "></span><span class="bold purple ">u</span><span class="highlighted dimgray ">xpxzolo</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-24 07:38:01</span> <span class="purple ">push-uxpxzoloznts</span> <span class="bold "></span><span class="bold blue ">b3</span><span class="highlighted dimgray ">26e556</span>
│ │  WIP: Add for loop (need to fix syntax)
<span class="bold "></span><span class="bold highlighted cyan ">◆</span> │  <span class="bold "></span><span class="bold purple ">w</span><span class="highlighted dimgray ">ruksqvz</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-24 07:38:02</span> <span class="purple ">main</span> <span class="green ">git_head()</span> <span class="bold "></span><span class="bold blue ">1</span><span class="highlighted dimgray ">18457e4</span>
│ │  Print German and French greetings as well
<span class="highlighted dimgray ">~</span> │  <span class="highlighted dimgray ">(elided revisions)</span>
├─╯
<span class="bold "></span><span class="bold highlighted cyan ">◆</span>  <span class="bold "></span><span class="bold purple ">kr</span><span class="highlighted dimgray ">opmvym</span> <span class="yellow ">alice@local</span> <span class="cyan ">2025-08-24 07:38:01</span> <span class="bold "></span><span class="bold blue ">8</span><span class="highlighted dimgray ">c90e9fc</span>
│  <span class="green ">(empty)</span> Merge code and documentation for hello-world
~
</pre>

素晴らしい！
競合解決はそれ自体が変更なので、コミットは最初のマージコミットのように "(empty)" ではなくなります。
それをコミットして `main` にプッシュしましょう：

```sh
jj commit -m "Merge repetition and translation of greeting"
jj bookmark move main --to @-
jj git push
```

````admonish info title="Rebase中の競合"
競合はrebase中にも発生します。
それらはより難しいです。
次のレベルで学びます。
Rebase中に競合に遭遇した場合、今は中止してマージコミットを作成することを検討してください（`jj undo` で）。
```

````admonish note title="競合解決を助けるツール" collapsible=true
上で教えたのは、競合マーカーを望ましい結果に置き換えることで競合を手動で解決することです。
それは常に動作します。
競合を手動で解決するのは面倒ですが。

特定の状況で競合を解決するのを助けるさまざまなツールがあります。
例えば、組み込みのツール `:ours` と `:theirs` は競合の一方を破棄して他方を保持します。
競合のどちら側が "ours" でどちらが "theirs" かは明白でないかもしれません。
一つ試して、必要なら `jj undo` を実行してください。
例えば：
```sh
# "our" 変更を保持し、"theirs" を破棄
jj resolve --tool :ours
```
組み込みツールに加えて、Jujutsuはより強力な外部ツールを呼び出すことができます。
一つの例は [Mergiraf](https://mergiraf.org/) です。
それは競合したファイルの**構文木**に基づいて競合を自動的に修正しようとします。
JujutsuはMergirafを同梱していませんが、必要なら別途インストールできます。
インストールしたら、このように使用します：
```sh
jj resolve --tool mergiraf
```
それはJujutsuがMergirafを呼び出す方法のデフォルトツール構成を持っているからです。
Jujutsuが知らない他のツールを使用したい場合、カスタム [merge tool configuration](https://jj-vcs.github.io/jj/latest/config/#3-way-merge-tools-for-conflict-resolution) を追加できます。
````
